{"version":3,"file":"Index-BhSvMeQw.js","sources":["../../src/shared/api/useDailySummary.ts","../../src/pages/daily-summary/Index.vue"],"sourcesContent":["import { storeToRefs } from 'pinia'\nimport { useUserStore } from '@/shared/api/stores/user'\nimport { useUi } from '@/shared/lib/composables/useUi'\nimport type { IAction } from '@/shared/types/api/IAction'\nimport { useApiClient } from '@/shared/api/useApiClient'\nimport type { IDailySummaryLog } from '@/shared/types/daily-summary/IDailySummary'\nimport type { IOperationalBase } from '@/shared/types/operational-bases/IOperationalBase'\n\nexport function useDailySummary() {\n  const { apiClient } = useApiClient()\n  const {\n    addToActionsInProgress,\n    removeFromActionsInProgress,\n    processActionError,\n    processActionSuccess,\n    resetActionsInError,\n    resetActionsInSuccess,\n  } = useUi()\n  const { user } = storeToRefs(useUserStore())\n\n  const dailySummaryActions = {\n    sendDailySummary: {\n      id: 'sendDailySummary',\n      successMessage: 'Daily Summary sent successfully.',\n      errorMessage: 'There was a problem sending the Daily Summary.',\n    } as IAction,\n    getDailySummaryByDate: {\n      id: 'getDailySummaryByDate',\n      successMessage: 'Daily Summary retrieved successfully.',\n      errorMessage: 'There was a problem retrieving the Daily Summary.',\n    } as IAction,\n  }\n\n  const apiGetDailySummaryByOpBaseAndDate = async (\n    operationalBase: IOperationalBase,\n    date: string,\n  ): Promise<IDailySummaryLog | void> => {\n    resetActionsInError()\n    addToActionsInProgress(dailySummaryActions.getDailySummaryByDate)\n\n    try {\n      const rsp = await apiClient.get('/api/daily-summary', {\n        params: {\n          selectedOperationalBaseId: operationalBase.id,\n          selectedDate: date,\n        },\n      })\n\n      removeFromActionsInProgress(dailySummaryActions.getDailySummaryByDate)\n\n      return rsp.data\n    }\n    catch (e: any) {\n      processActionError(dailySummaryActions.getDailySummaryByDate, e)\n    }\n  }\n\n  const sendDailySummary = async (dailySummary: IDailySummaryLog) => {\n    resetActionsInError()\n    resetActionsInSuccess()\n    addToActionsInProgress(dailySummaryActions.sendDailySummary)\n\n    try {\n      await apiClient.post('/api/daily-summary', dailySummary)\n\n      removeFromActionsInProgress(dailySummaryActions.sendDailySummary)\n      processActionSuccess(dailySummaryActions.sendDailySummary)\n      setTimeout(() => {\n        resetActionsInSuccess()\n      }, 3000)\n    }\n    catch (e: any) {\n      console.log(e)\n      processActionError(dailySummaryActions.sendDailySummary, e)\n    }\n  }\n\n  return {\n    user,\n    dailySummaryActions,\n    apiGetDailySummaryByOpBaseAndDate,\n    sendDailySummary,\n  }\n}\n","<script setup lang=\"ts\">\nimport { ref, watch } from 'vue'\nimport { storeToRefs } from 'pinia'\nimport MainContent from '@/shared/ui/layout/MainContent.vue'\nimport { useUi } from '@/shared/lib/composables/useUi'\nimport { useDailySummary } from '@/shared/api/useDailySummary'\nimport VDataFilters from '@/shared/ui/inputs/VDataFilters.vue'\nimport type { IDataFilters } from '@/shared/types/inputs/IDataFilters'\nimport type { IDailySummaryLog } from '@/shared/types/daily-summary/IDailySummary'\nimport FeedbackWarning from '@/shared/ui/FeedbackWarning.vue'\nimport IconTickMarkCircle from '@/shared/ui/icons/IconTickMarkCircle.vue'\nimport { AppPermissions } from '@/shared/types/enums/permissions/permissions'\nimport VActionButton from '@/shared/ui/forms/VActionButton.vue'\nimport { useUserStore } from '@/shared/api/stores/user'\n\nconst { actionIsInProgress, getActionSuccessMessage, actionIsInSuccess, validateForm } = useUi()\nconst {\n  sendDailySummary,\n  apiGetDailySummaryByOpBaseAndDate,\n  dailySummaryActions,\n} = useDailySummary()\n\nconst { user } = storeToRefs(useUserStore())\n\nconst dailySummaryFormElement = ref<HTMLFormElement | null>(null)\n\n// const fileupload = ref('')\n\nconst filterState = ref<IDataFilters>({\n  selectedDepartment: null,\n  selectedOperationalBase: null,\n  selectedRole: null,\n  selectedMonth: '',\n  selectedDate: '',\n})\n\nconst dailySummaryLog = ref<IDailySummaryLog | null>(null)\nconst loading = ref(true)\n\nconst handleFilterStateUpdate = async (newFilterState: IDataFilters) => {\n  filterState.value = newFilterState\n}\n\nconst handleFormSubmission = async () => {\n  await validateForm(\n    dailySummaryFormElement.value,\n    async () => {\n      if (dailySummaryLog.value) {\n        dailySummaryLog.value.user = user.value\n        await sendDailySummary(dailySummaryLog.value)\n      }\n    },\n  )\n}\n\n/*\nconst handleFileUpload = (event: Event) => {\n  const target = event.target as HTMLInputElement\n  const file = target.files?.[0]\n  if (file && dailySummaryLog.value) {\n    dailySummaryLog.value.dailySummaryLogMedia.filePath = file\n    const reader = new FileReader()\n    reader.onload = (e) => {\n      const result = e.target?.result\n      if (result) {\n        fileupload.value = result as string\n      }\n    }\n    reader.readAsDataURL(file)\n  }\n}\n */\n\nwatch (\n  () => filterState.value,\n  async (newValue, oldValue) => {\n    if (newValue !== oldValue) {\n      if (\n        filterState.value.selectedDepartment\n        && filterState.value.selectedOperationalBase\n        && filterState.value.selectedDate\n      ) {\n        // fetch existing daily summaries for this operational base and date\n        const dailySummary = await apiGetDailySummaryByOpBaseAndDate(\n          filterState.value.selectedOperationalBase,\n          filterState.value.selectedDate,\n        )\n\n        if (dailySummary) {\n          dailySummaryLog.value = {\n            id: dailySummary.id,\n            departmentId: dailySummary.departmentId,\n            dailySummaryFormId: dailySummary.dailySummaryFormId,\n            user: dailySummary.user ? dailySummary.user : null,\n            date: dailySummary.date,\n            dailySummaryFormItems: dailySummary.dailySummaryFormItems,\n            dailySummaryLogItems: dailySummary.dailySummaryLogItems,\n            dailySummaryLogMedia: dailySummary.dailySummaryLogMedia,\n          }\n        }\n        else {\n          dailySummaryLog.value = null\n        }\n\n        loading.value = false\n      }\n    }\n  },\n)\n</script>\n\n<template>\n  <MainContent main-content-title=\"Daily Summary\">\n    <form\n      ref=\"dailySummaryFormElement\"\n      class=\"space-y-8 divide-y divide-gray-200\"\n    >\n      <div>\n        <VDataFilters\n          :department-permissions-required=\"[\n            AppPermissions.VIEW_DAILY_SUMMARY,\n          ]\"\n          filter-by-operational-bases\n          filter-by-date\n          :filter-state=\"filterState\"\n          @filter-state-updated=\"handleFilterStateUpdate\"\n        />\n        <p class=\"mt-3 text-sm text-gray-500\">\n          This report is emailed to the contacts in the daily summary event notification for this department. It is a quick way to communicate any issues that might have arisen during the day.\n        </p>\n      </div>\n      <div class=\"space-y-8 divide-y divide-gray-200 sm:space-y-5\">\n        <div class=\"space-y-6 sm:space-y-5\">\n          <FeedbackWarning\n            v-if=\"!loading && !dailySummaryLog && !actionIsInProgress(dailySummaryActions.getDailySummaryByDate)\"\n            title=\"No Daily Summary form found\"\n            message=\"We couldn't find a Daily Summary form for the selected department and operational base!\"\n          />\n          <FeedbackWarning\n            v-if=\"dailySummaryLog && dailySummaryLog.id\"\n            title=\"Just so you know...\"\n            :message=\"`A Daily Summary for ${filterState.selectedDate} was already submitted by ${dailySummaryLog.user?.fullName} for ${filterState.selectedOperationalBase?.name}.`\"\n          />\n\n          <div\n            v-if=\"dailySummaryLog\"\n            class=\"max-w-[1280px] space-y-6 sm:space-y-5\"\n          >\n            <div\n              v-for=\"(formItem, i) in dailySummaryLog.dailySummaryFormItems\"\n              :key=\"i\"\n              class=\"sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-200 sm:pt-5\"\n            >\n              <label for=\"departures\" class=\"block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2\">\n                {{ formItem.label }}\n              </label>\n              <div class=\"mt-1 sm:col-span-2 sm:mt-0\">\n                <textarea\n                  v-model=\"dailySummaryLog.dailySummaryLogItems[i].answer\"\n                  rows=\"3\"\n                  class=\"block w-full max-w-lg rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\"\n                  maxlength=\"1000\"\n                  required\n                />\n                <p class=\"mt-2 text-sm text-gray-500\">\n                  {{ formItem.question }}\n                </p>\n              </div>\n            </div>\n\n            <!--\n            <div class=\"sm:grid sm:grid-cols-3 sm:items-start sm:gap-4 sm:border-t sm:border-gray-200 sm:pt-5\">\n              <label for=\"cover-photo\" class=\"block text-sm font-medium text-gray-700 sm:mt-px sm:pt-2\">\n                Select image to upload.\n              </label>\n              <div class=\"mt-1 sm:col-span-2 sm:mt-0\">\n                <div class=\"flex max-w-lg justify-center rounded-md border-2 border-dashed border-gray-300 px-6 pb-6 pt-5\">\n                  <div class=\"space-y-1 text-center\">\n                    <img\n                      v-if=\"fileupload\"\n                      :src=\"fileupload\"\n                      class=\"mx-auto w-full max-w-[200px] text-gray-400\"\n                      alt=\"Media\"\n                    >\n                    <svg\n                      v-else\n                      class=\"mx-auto h-12 w-12 text-gray-400\"\n                      stroke=\"currentColor\"\n                      fill=\"none\"\n                      viewBox=\"0 0 48 48\"\n                      aria-hidden=\"true\"\n                    >\n                      <path\n                        d=\"M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02\"\n                        stroke-width=\"2\"\n                        stroke-linecap=\"round\"\n                        stroke-linejoin=\"round\"\n                      />\n                    </svg>\n                    <div class=\"flex text-sm text-gray-600\">\n                      <label for=\"file-upload\" class=\"relative cursor-pointer rounded-md bg-white font-medium text-blue-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-blue-500 focus-within:ring-offset-2 hover:text-blue-500\">\n                        <span>Upload a file</span>\n                        <input\n                          id=\"file-upload\"\n                          name=\"file-upload\"\n                          type=\"file\"\n                          accept=\"image/jpeg, image/png, image/gif, image/jpg, image/webp\"\n                          class=\"sr-only\"\n                          @change=\"handleFileUpload\"\n                        >\n                      </label>\n                      <p class=\"pl-1\">\n                        or drag and drop\n                      </p>\n                    </div>\n                    <p class=\"text-xs text-gray-500\">\n                      PNG, JPG, GIF up to 10MB\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n            -->\n          </div>\n        </div>\n      </div>\n\n      <VActionButton\n        v-if=\"dailySummaryLog && filterState.selectedDepartment\"\n        :action=\"handleFormSubmission\"\n        :permission-required=\"{\n          permission: AppPermissions.SEND_DAILY_SUMMARIES,\n          department: filterState.selectedDepartment,\n        }\"\n        :loading=\"actionIsInProgress(dailySummaryActions.sendDailySummary)\"\n        label=\"Save Daily Summary\"\n      />\n\n      <Transition name=\"save\">\n        <div\n          v-if=\"actionIsInSuccess(dailySummaryActions.sendDailySummary)\"\n          class=\"fixed inset-x-0 top-0 flex justify-center p-2\"\n        >\n          <div class=\"w-64 rounded-md border border-green-100 bg-green-50 p-3 md:p-4\">\n            <div class=\"flex\">\n              <div class=\"shrink-0\">\n                <IconTickMarkCircle class=\"h-5 w-5 fill-green-400\" />\n              </div>\n              <div class=\"ml-3\">\n                <p\n                  class=\"text-sm text-green-700\"\n                  v-html=\"getActionSuccessMessage(dailySummaryActions.sendDailySummary)\"\n                />\n              </div>\n            </div>\n          </div>\n        </div>\n      </Transition>\n    </form>\n  </MainContent>\n</template>\n\n<style scoped>\n.v-enter-active,\n.v-leave-active {\n    transition: opacity 0.2s ease;\n}\n.v-leave-to {\n    transition-delay: 0.5s;\n    opacity: 0;\n}\n\n.save-enter-active,\n.save-leave-active {\n    transition: transform 0.2s ease-in-out;\n}\n.save-enter-from,\n.save-leave-to {\n    transform: translateY(-100%);\n}\n</style>\n"],"names":["useDailySummary","apiClient","useApiClient","addToActionsInProgress","removeFromActionsInProgress","processActionError","processActionSuccess","resetActionsInError","resetActionsInSuccess","useUi","user","storeToRefs","useUserStore","dailySummaryActions","operationalBase","date","rsp","e","dailySummary","actionIsInProgress","getActionSuccessMessage","actionIsInSuccess","validateForm","sendDailySummary","apiGetDailySummaryByOpBaseAndDate","dailySummaryFormElement","ref","filterState","dailySummaryLog","loading","handleFilterStateUpdate","newFilterState","handleFormSubmission","watch","newValue","oldValue"],"mappings":"w9FAQO,SAASA,GAAkB,CAC1B,KAAA,CAAE,UAAAC,GAAcC,IAChB,CACJ,uBAAAC,EACA,4BAAAC,EACA,mBAAAC,EACA,qBAAAC,EACA,oBAAAC,EACA,sBAAAC,GACEC,EAAM,EACJ,CAAE,KAAAC,CAAS,EAAAC,EAAYC,EAAc,CAAA,EAErCC,EAAsB,CAC1B,iBAAkB,CAChB,GAAI,mBACJ,eAAgB,mCAChB,aAAc,gDAChB,EACA,sBAAuB,CACrB,GAAI,wBACJ,eAAgB,wCAChB,aAAc,mDAChB,CAAA,EA+CK,MAAA,CACL,KAAAH,EACA,oBAAAG,EACA,kCA/CwC,MACxCC,EACAC,IACqC,CACjBR,IACpBJ,EAAuBU,EAAoB,qBAAqB,EAE5D,GAAA,CACF,MAAMG,EAAM,MAAMf,EAAU,IAAI,qBAAsB,CACpD,OAAQ,CACN,0BAA2Ba,EAAgB,GAC3C,aAAcC,CAChB,CAAA,CACD,EAED,OAAAX,EAA4BS,EAAoB,qBAAqB,EAE9DG,EAAI,WAENC,EAAQ,CACMZ,EAAAQ,EAAoB,sBAAuBI,CAAC,CACjE,CAAA,EA2BA,iBAxBuB,MAAOC,GAAmC,CAC7CX,IACEC,IACtBL,EAAuBU,EAAoB,gBAAgB,EAEvD,GAAA,CACI,MAAAZ,EAAU,KAAK,qBAAsBiB,CAAY,EAEvDd,EAA4BS,EAAoB,gBAAgB,EAChEP,EAAqBO,EAAoB,gBAAgB,EACzD,WAAW,IAAM,CACOL,KACrB,GAAI,QAEFS,EAAQ,CACb,QAAQ,IAAIA,CAAC,EACMZ,EAAAQ,EAAoB,iBAAkBI,CAAC,CAC5D,CAAA,CAOA,CAEJ,s3BCpEA,KAAM,CAAE,mBAAAE,EAAoB,wBAAAC,EAAyB,kBAAAC,EAAmB,aAAAC,CAAA,EAAiBb,IACnF,CACJ,iBAAAc,EACA,kCAAAC,EACA,oBAAAX,GACEb,EAAgB,EAEd,CAAE,KAAAU,CAAS,EAAAC,EAAYC,EAAc,CAAA,EAErCa,EAA0BC,EAA4B,IAAI,EAI1DC,EAAcD,EAAkB,CACpC,mBAAoB,KACpB,wBAAyB,KACzB,aAAc,KACd,cAAe,GACf,aAAc,EAAA,CACf,EAEKE,EAAkBF,EAA6B,IAAI,EACnDG,EAAUH,EAAI,EAAI,EAElBI,EAA0B,MAAOC,GAAiC,CACtEJ,EAAY,MAAQI,CAAA,EAGhBC,EAAuB,SAAY,CACjC,MAAAV,EACJG,EAAwB,MACxB,SAAY,CACNG,EAAgB,QACFA,EAAA,MAAM,KAAOlB,EAAK,MAC5B,MAAAa,EAAiBK,EAAgB,KAAK,EAEhD,CAAA,CACF,EAqBF,OAAAK,EACE,IAAMN,EAAY,MAClB,MAAOO,EAAUC,IAAa,CAC5B,GAAID,IAAaC,GAEbR,EAAY,MAAM,oBACfA,EAAY,MAAM,yBAClBA,EAAY,MAAM,aACrB,CAEA,MAAMT,EAAe,MAAMM,EACzBG,EAAY,MAAM,wBAClBA,EAAY,MAAM,YAAA,EAGhBT,EACFU,EAAgB,MAAQ,CACtB,GAAIV,EAAa,GACjB,aAAcA,EAAa,aAC3B,mBAAoBA,EAAa,mBACjC,KAAMA,EAAa,KAAOA,EAAa,KAAO,KAC9C,KAAMA,EAAa,KACnB,sBAAuBA,EAAa,sBACpC,qBAAsBA,EAAa,qBACnC,qBAAsBA,EAAa,oBAAA,EAIrCU,EAAgB,MAAQ,KAG1BC,EAAQ,MAAQ,EAClB,CAEJ,CAAA"}