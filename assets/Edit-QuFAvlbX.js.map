{"version":3,"file":"Edit-QuFAvlbX.js","sources":["../../src/pages/staff-bases/Edit.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { nextTick, onBeforeUnmount, onMounted, ref, toRefs, watch } from 'vue'\nimport L from 'leaflet'\nimport RightDrawer from '@/shared/ui/layout/RightDrawer.vue'\nimport { useUi } from '@/shared/lib/composables/useUi'\nimport IconClose from '@/shared/ui/icons/IconClose.vue'\nimport ProgressSpinner from '@/shared/ui/ProgressSpinner.vue'\nimport ActionSuccessAlert from '@/shared/ui/forms/ActionSuccessAlert.vue'\nimport ActionErrorAlert from '@/shared/ui/forms/ActionErrorAlert.vue'\nimport { useStaffBases } from '@/shared/api/useStaffBases'\nimport type { IEditStaffBaseFormData } from '@/shared/types/staff-bases/IEditStaffBaseFormData'\nimport type { IStaffBase } from '@/shared/types/staff-bases/IStaffBase'\n\nconst props = defineProps<{ staffBaseId: number }>()\nconst { staffBaseId } = toRefs(props)\n\nconst { validateForm, actionIsInProgress, actionIsInError, actionIsInSuccess } = useUi()\nconst { staffBaseActions, getStaffBaseById, editStaffBase } = useStaffBases()\n\nconst editStaffBaseFormElement = ref<HTMLFormElement | null>(null)\nconst editStaffBaseFormData = ref<IEditStaffBaseFormData | null>(null)\n\nconst handleEditStaffBase = async () => {\n  const staffBase = await validateForm<IStaffBase>(editStaffBaseFormElement.value, () => editStaffBase(editStaffBaseFormData.value))\n  if (staffBase) {\n    editStaffBaseFormData.value = staffBase\n  }\n}\nlet map: L.Map | null = null\n\nconst handleUpdateMap = () => {\n  map = L.map('map', {\n    center: [\n      +editStaffBaseFormData.value!.latitude,\n      +editStaffBaseFormData.value!.longitude,\n    ],\n    zoom: 11,\n  })\n\n  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map)\n\n  // Place the initial marker at the center of the map\n  let staffBaseLocationMarker = L.marker(\n    [\n      +editStaffBaseFormData.value!.latitude,\n      +editStaffBaseFormData.value!.longitude,\n    ],\n  ).addTo(map)\n\n  // TODO - tidy up leaflet types\n  map.on('click', (e) => {\n    editStaffBaseFormData.value!.latitude = e.latlng.lat.toString()\n    editStaffBaseFormData.value!.longitude = e.latlng.lng.toString()\n\n    // Remove the previous marker\n    if (staffBaseLocationMarker) {\n      map!.removeLayer(staffBaseLocationMarker)\n    }\n\n    // Add a new marker where the map was clicked\n    staffBaseLocationMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map!)\n  })\n\n  // This is important- the map needs to be reset because of the way the\n  // side bar comes in to view. Otherwise the tiles are offset.\n  map.setView(new L.LatLng(\n    +editStaffBaseFormData.value!.latitude,\n    +editStaffBaseFormData.value!.longitude,\n  ), 11)\n}\n\nonMounted(async () => {\n  editStaffBaseFormData.value = await getStaffBaseById(staffBaseId.value.toString())\n  await nextTick(() => {\n    setTimeout(() => handleUpdateMap(), 400)\n  })\n})\n\nonBeforeUnmount(() => {\n  if (map) {\n    map.off()\n    map.remove()\n  }\n})\n\nwatch(\n  staffBaseId,\n  async (newId) => {\n    if (newId) {\n      editStaffBaseFormData.value = await getStaffBaseById(newId.toString())\n      if (map) {\n        map.off()\n        map.remove()\n      }\n      handleUpdateMap()\n    }\n  },\n)\n</script>\n\n<template>\n  <RightDrawer>\n    <div class=\"isolate flex flex-col items-center justify-center border-l bg-white pb-6\">\n      <!-- important to increase z index to sit on top of map -->\n      <div class=\"sticky top-0 z-[9999999] flex w-full items-center justify-end bg-white p-6\">\n        <ProgressSpinner\n          v-if=\"actionIsInProgress(staffBaseActions.getStaffBaseById)\n            || actionIsInProgress(staffBaseActions.editStaffBase)\"\n          class=\"h-5 w-5 text-blue-500\"\n        />\n        <RouterLink\n          v-else\n          :to=\"{ name: $Routes.StaffBases }\"\n        >\n          <IconClose class=\"h-5 w-5 fill-red-400\" />\n        </RouterLink>\n      </div>\n      <form\n        id=\"edit_staff_base_form\"\n        ref=\"editStaffBaseFormElement\"\n        class=\"w-full space-y-8 divide-y divide-gray-200 px-6 md:px-12\"\n      >\n        <div class=\"mb-6\">\n          <h3 class=\"text-base font-semibold leading-6 text-gray-900\">\n            View/Edit Staff Base.\n          </h3>\n          <p class=\"mt-1 text-sm text-gray-500\">\n            Use the form below to update this staff base.\n          </p>\n        </div>\n\n        <template v-if=\"editStaffBaseFormData\">\n          <div class=\"grid grid-cols-1 gap-x-4 gap-y-6 pt-6\">\n            <div>\n              <label for=\"staff_base_name\" class=\"block text-sm font-medium text-gray-700\">\n                Staff Base Name\n              </label>\n              <div class=\"mt-1\">\n                <input\n                  id=\"staff_base_name\"\n                  v-model=\"editStaffBaseFormData.name\"\n                  type=\"text\"\n                  class=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\"\n                  required\n                >\n              </div>\n            </div>\n\n            <div\n              id=\"map\"\n              class=\"h-[400px] w-full bg-gray-100\"\n            />\n            <p class=\"text-xs italic text-gray-500\">\n              {{ editStaffBaseFormData.latitude }}, {{ editStaffBaseFormData.longitude }}\n            </p>\n          </div>\n\n          <div class=\"relative pt-5\">\n            <div class=\"flex items-center justify-end\">\n              <Transition name=\"alert\">\n                <ActionSuccessAlert\n                  v-if=\"actionIsInSuccess(staffBaseActions.editStaffBase)\"\n                  :action=\"staffBaseActions.editStaffBase\"\n                />\n              </Transition>\n              <Transition name=\"alert\">\n                <ActionErrorAlert\n                  v-if=\"actionIsInError(staffBaseActions.editStaffBase)\"\n                  :action=\"staffBaseActions.editStaffBase\"\n                />\n              </Transition>\n              <div class=\"flex items-center\">\n                <button\n                  class=\"ml-3 inline-flex h-9 items-center justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm focus:outline-none hover:bg-blue-700\"\n                  @click.prevent=\"handleEditStaffBase\"\n                >\n                  <span v-if=\"!actionIsInProgress(staffBaseActions.editStaffBase)\">\n                    Apply Changes\n                  </span>\n                  <ProgressSpinner\n                    v-else\n                    class=\"h-3 w-3 text-white\"\n                  />\n                </button>\n              </div>\n            </div>\n          </div>\n        </template>\n      </form>\n    </div>\n  </RightDrawer>\n</template>\n"],"names":["props","__props","staffBaseId","toRefs","validateForm","actionIsInProgress","actionIsInError","actionIsInSuccess","useUi","staffBaseActions","getStaffBaseById","editStaffBase","useStaffBases","editStaffBaseFormElement","ref","editStaffBaseFormData","handleEditStaffBase","staffBase","map","handleUpdateMap","L","staffBaseLocationMarker","e","onMounted","nextTick","onBeforeUnmount","watch","newId"],"mappings":"4rHAaA,MAAMA,EAAQC,EACR,CAAE,YAAAC,CAAA,EAAgBC,EAAOH,CAAK,EAE9B,CAAE,aAAAI,EAAc,mBAAAC,EAAoB,gBAAAC,EAAiB,kBAAAC,CAAA,EAAsBC,IAC3E,CAAE,iBAAAC,EAAkB,iBAAAC,EAAkB,cAAAC,GAAkBC,EAAc,EAEtEC,EAA2BC,EAA4B,IAAI,EAC3DC,EAAwBD,EAAmC,IAAI,EAE/DE,EAAsB,SAAY,CAChC,MAAAC,EAAY,MAAMb,EAAyBS,EAAyB,MAAO,IAAMF,EAAcI,EAAsB,KAAK,CAAC,EAC7HE,IACFF,EAAsB,MAAQE,EAChC,EAEF,IAAIC,EAAoB,KAExB,MAAMC,EAAkB,IAAM,CACtBD,EAAAE,EAAE,IAAI,MAAO,CACjB,OAAQ,CACN,CAACL,EAAsB,MAAO,SAC9B,CAACA,EAAsB,MAAO,SAChC,EACA,KAAM,EAAA,CACP,EAEDK,EAAE,UAAU,+FAA+F,EAAE,MAAMF,CAAG,EAGtH,IAAIG,EAA0BD,EAAE,OAC9B,CACE,CAACL,EAAsB,MAAO,SAC9B,CAACA,EAAsB,MAAO,SAChC,CAAA,EACA,MAAMG,CAAG,EAGPA,EAAA,GAAG,QAAUI,GAAM,CACrBP,EAAsB,MAAO,SAAWO,EAAE,OAAO,IAAI,WACrDP,EAAsB,MAAO,UAAYO,EAAE,OAAO,IAAI,WAGlDD,GACFH,EAAK,YAAYG,CAAuB,EAI1CA,EAA0BD,EAAE,OAAO,CAACE,EAAE,OAAO,IAAKA,EAAE,OAAO,GAAG,CAAC,EAAE,MAAMJ,CAAI,CAAA,CAC5E,EAIGA,EAAA,QAAQ,IAAIE,EAAE,OAChB,CAACL,EAAsB,MAAO,SAC9B,CAACA,EAAsB,MAAO,WAC7B,EAAE,CAAA,EAGP,OAAAQ,EAAU,SAAY,CACpBR,EAAsB,MAAQ,MAAML,EAAiBR,EAAY,MAAM,UAAU,EACjF,MAAMsB,EAAS,IAAM,CACR,WAAA,IAAML,IAAmB,GAAG,CAAA,CACxC,CAAA,CACF,EAEDM,EAAgB,IAAM,CAChBP,IACFA,EAAI,IAAI,EACRA,EAAI,OAAO,EACb,CACD,EAEDQ,EACExB,EACA,MAAOyB,GAAU,CACXA,IACFZ,EAAsB,MAAQ,MAAML,EAAiBiB,EAAM,SAAU,CAAA,EACjET,IACFA,EAAI,IAAI,EACRA,EAAI,OAAO,GAEGC,IAEpB,CAAA"}