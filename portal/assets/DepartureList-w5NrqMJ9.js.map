{"version":3,"file":"DepartureList-w5NrqMJ9.js","sources":["../../src/widgets/departure-list/DepartureList.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { computed, ref, toRefs } from 'vue'\nimport { notNullish, objectPick } from '@antfu/utils'\n\nimport { DepartureAssignStaffAndVehicles } from '@/features/departure/assign-staff-and-vehicles'\n\nimport type {\n  Department,\n  OperationalBase,\n  ScheduledDeparture,\n} from '@/shared/types'\nimport { formatRelativeDay } from '@/shared/lib/date'\n\nimport { useDeparturesByOperationalBaseAndDate } from '@/shared/api/scheduled-departure'\nimport { useUsers } from '@/shared/api/user'\nimport { useVehicles } from '@/shared/api/vehicle'\n\nimport { PAlert } from '@/shared/ui/PAlert'\nimport { POverlay } from '@/shared/ui/POverlay'\nimport { PDialog } from '@/shared/ui/PDialog'\n\nimport { DepartureListItem } from './ui/item'\n\nconst props = defineProps<{\n  date?: Date | null\n  departmentId?: Department['id'] | null\n  operationalBaseId?: OperationalBase['id'] | null\n  showClosedOrCancelled?: boolean\n  compact?: boolean\n  showFallback?: boolean\n}>()\nconst {\n  date, departmentId, operationalBaseId, showClosedOrCancelled,\n} = toRefs(props)\n\nconst {\n  isFetched,\n  isLoading,\n  isRefetching,\n  data: scheduledDepartures,\n} = useDeparturesByOperationalBaseAndDate({ date, operationalBaseId })\n\nconst { data: users } = useUsers()\nconst { data: vehicles } = useVehicles()\n\nconst filteredScheduledDepartures = computed(\n  () => scheduledDepartures.value?.filter(\n    (se) => showClosedOrCancelled.value || (\n      se.totalPassengerCount\n    ),\n  ).map((se) => ({\n    ...se,\n    scheduledUsers: se.scheduledUsers.map((su) => {\n      const user = users.value?.find((u) => u.id === su.userId)\n      const vehicle = vehicles.value?.find((v) => v.id === su.vehicleId)\n\n      if (!user || (su.vehicleId && !vehicle)) return null\n\n      return {\n        ...objectPick(user, ['id', 'name', 'avatar', 'phone']),\n        vehicleRegistrationNumber: vehicle?.registrationNumber ?? null,\n        vehicleTitle: vehicle?.title ?? null,\n        maxCapacity: vehicle?.maxCapacity ?? 0,\n        bookingSystemAvailability: se.bookingSystemAvailability,\n      }\n    }).filter(notNullish),\n  })),\n)\n\nconst isAssignmentOpen = ref(false)\n\nconst selectedScheduledDepartureId = ref<ScheduledDeparture['id'] | null>(null)\nconst selectedScheduledDeparture = computed(\n  () => scheduledDepartures.value?.find(\n    (se) => se.id === selectedScheduledDepartureId.value,\n  ),\n)\n\nconst startAssignment = (id: ScheduledDeparture['id']) => {\n  selectedScheduledDepartureId.value = id\n  isAssignmentOpen.value = true\n}\n\nconst finishAssignment = () => {\n  selectedScheduledDepartureId.value = null\n  isAssignmentOpen.value = false\n}\n\nconst parseTime = (timeString: string) => {\n  const [hours, minutes] = timeString.split(':').map(Number)\n  return hours * 60 + minutes\n}\n\nconst sortedDepartures = computed(() => {\n  return filteredScheduledDepartures.value?.slice().sort((a, b) => {\n    const timeA = parseTime(a.departure.time)\n    const timeB = parseTime(b.departure.time)\n    return timeA - timeB\n  })\n})\n</script>\n\n<template>\n  <div>\n    <POverlay v-if=\"date\" :show=\"isLoading || isRefetching\" :class=\"isLoading && 'min-h-80'\">\n      <PAlert\n        v-if=\"showFallback && isFetched && !isLoading && !sortedDepartures?.length\"\n        variant=\"warn\"\n      >\n        <template #heading>\n          No departures for this day\n        </template>\n\n        Have you created any experiences for this department?\n      </PAlert>\n      <div v-else :class=\"!compact && 'space-y-4'\">\n        <span\n          v-if=\"filteredScheduledDepartures?.length\"\n          class=\"\n          inline-block rounded-lg rounded-tl-none bg-teal-100 px-3 py-1\n          text-xs leading-none\n          \"\n        >\n          {{ formatRelativeDay(date) }}\n        </span>\n\n        <div class=\"flex flex-col\" :class=\"!compact && 'gap-4'\">\n          <div\n            v-for=\"{\n              id,\n              comment,\n              status,\n              totalPassengerCount,\n              tour: { name, thumbnailUrl },\n              departure: { time: time },\n              scheduledUsers,\n              bookingSystemAvailability,\n            } in sortedDepartures\"\n            :key=\"id\"\n          >\n            <RouterLink\n              v-slot=\"{ href, navigate }\"\n              :to=\"{\n                name: $Routes.DepartureShow,\n                params: { departureId: id },\n              }\"\n              custom\n            >\n              <a\n                v-if=\"!compact\"\n                class=\"mb-1 text-gray-500\"\n                :href=\"href\"\n                @click=\"navigate\"\n                v-text=\"name\"\n              />\n\n              <DepartureListItem\n                :scheduled-departure-id=\"id\"\n                :booking-system-availability=\"bookingSystemAvailability\"\n                :tour-name=\"name\"\n                :tour-thumbnail-url=\"thumbnailUrl\"\n                :time=\"time\"\n                :total-passenger-count=\"totalPassengerCount\"\n                :comment=\"comment\"\n                :status=\"status\"\n                :scheduled-users=\"scheduledUsers\"\n                :compact=\"compact\"\n                @start-assignment=\"startAssignment(id)\"\n              />\n            </RouterLink>\n          </div>\n        </div>\n      </div>\n    </POverlay>\n\n    <template v-if=\"date && departmentId && operationalBaseId\">\n      <PDialog\n        :open=\"isAssignmentOpen\"\n        @close=\"isAssignmentOpen = false\"\n        @closed=\"selectedScheduledDepartureId = null\"\n      >\n        <DepartureAssignStaffAndVehicles\n          v-if=\"selectedScheduledDeparture\"\n          class=\"md:w-[43rem]\"\n          :scheduled-departure-id=\"selectedScheduledDepartureId\"\n          :tour-time=\"selectedScheduledDeparture.departure.time\"\n          :tour-name=\"selectedScheduledDeparture.tour.name\"\n          :scheduled-users=\"selectedScheduledDeparture.scheduledUsers\"\n          @close=\"finishAssignment\"\n        />\n      </PDialog>\n    </template>\n  </div>\n</template>\n"],"names":["props","__props","date","departmentId","operationalBaseId","showClosedOrCancelled","toRefs","isFetched","isLoading","isRefetching","scheduledDepartures","useDeparturesByOperationalBaseAndDate","users","useUsers","vehicles","useVehicles","filteredScheduledDepartures","computed","_a","se","su","user","u","vehicle","_b","v","objectPick","notNullish","isAssignmentOpen","ref","selectedScheduledDepartureId","selectedScheduledDeparture","startAssignment","id","finishAssignment","parseTime","timeString","hours","minutes","sortedDepartures","b","timeA","timeB"],"mappings":"i7BAuBA,MAAMA,EAAQC,EAQR,CACJ,KAAAC,EAAM,aAAAC,EAAc,kBAAAC,EAAmB,sBAAAC,CAAA,EACrCC,EAAON,CAAK,EAEV,CACJ,UAAAO,EACA,UAAAC,EACA,aAAAC,EACA,KAAMC,CACJ,EAAAC,GAAsC,CAAE,KAAAT,EAAM,kBAAAE,CAAmB,CAAA,EAE/D,CAAE,KAAMQ,CAAM,EAAIC,GAAS,EAC3B,CAAE,KAAMC,CAAS,EAAIC,GAAY,EAEjCC,EAA8BC,EAClC,IAAM,OAAA,OAAAC,EAAAR,EAAoB,QAApB,YAAAQ,EAA2B,OAC9BC,GAAOd,EAAsB,OAC5Bc,EAAG,qBAEL,IAAKA,IAAQ,CACb,GAAGA,EACH,eAAgBA,EAAG,eAAe,IAAKC,GAAO,SACtC,MAAAC,GAAOH,EAAAN,EAAM,QAAN,YAAAM,EAAa,KAAMI,GAAMA,EAAE,KAAOF,EAAG,QAC5CG,GAAUC,EAAAV,EAAS,QAAT,YAAAU,EAAgB,KAAMC,GAAMA,EAAE,KAAOL,EAAG,WAExD,MAAI,CAACC,GAASD,EAAG,WAAa,CAACG,EAAiB,KAEzC,CACL,GAAGG,GAAWL,EAAM,CAAC,KAAM,OAAQ,SAAU,OAAO,CAAC,EACrD,2BAA2BE,GAAA,YAAAA,EAAS,qBAAsB,KAC1D,cAAcA,GAAA,YAAAA,EAAS,QAAS,KAChC,aAAaA,GAAA,YAAAA,EAAS,cAAe,EACrC,0BAA2BJ,EAAG,yBAAA,CAChC,CACD,EAAE,OAAOQ,EAAU,CAAA,IACpB,EAGEC,EAAmBC,EAAI,EAAK,EAE5BC,EAA+BD,EAAqC,IAAI,EACxEE,EAA6Bd,EACjC,IAAM,OAAA,OAAAC,EAAAR,EAAoB,QAApB,YAAAQ,EAA2B,KAC9BC,GAAOA,EAAG,KAAOW,EAA6B,OACjD,EAGIE,EAAmBC,GAAiC,CACxDH,EAA6B,MAAQG,EACrCL,EAAiB,MAAQ,EAAA,EAGrBM,EAAmB,IAAM,CAC7BJ,EAA6B,MAAQ,KACrCF,EAAiB,MAAQ,EAAA,EAGrBO,EAAaC,GAAuB,CAClC,KAAA,CAACC,EAAOC,CAAO,EAAIF,EAAW,MAAM,GAAG,EAAE,IAAI,MAAM,EACzD,OAAOC,EAAQ,GAAKC,CAAA,EAGhBC,EAAmBtB,EAAS,IAAM,OACtC,OAAOC,EAAAF,EAA4B,QAA5B,YAAAE,EAAmC,QAAQ,KAAK,CAAC,EAAGsB,IAAM,CAC/D,MAAMC,EAAQN,EAAU,EAAE,UAAU,IAAI,EAClCO,EAAQP,EAAUK,EAAE,UAAU,IAAI,EACxC,OAAOC,EAAQC,CAAA,EAChB,CACF"}