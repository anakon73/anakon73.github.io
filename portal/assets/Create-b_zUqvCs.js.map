{"version":3,"file":"Create-b_zUqvCs.js","sources":["../../src/shared/config/maps/Coordinates.ts","../../src/pages/operational-bases/Create.vue"],"sourcesContent":["export enum DefaultMapCoordinates {\n  LAT = '64.025125',\n  LNG = '-16.978723',\n}\n","<script setup lang=\"ts\">\nimport { nextTick, onBeforeUnmount, onMounted, ref } from 'vue'\nimport type L from 'leaflet'\nimport { storeToRefs } from 'pinia'\nimport RightDrawer from '@/shared/ui/layout/RightDrawer.vue'\nimport { useUi } from '@/shared/lib/composables/useUi'\nimport IconClose from '@/shared/ui/icons/IconClose.vue'\nimport ProgressSpinner from '@/shared/ui/ProgressSpinner.vue'\nimport ActionSuccessAlert from '@/shared/ui/forms/ActionSuccessAlert.vue'\nimport ActionErrorAlert from '@/shared/ui/forms/ActionErrorAlert.vue'\nimport { useOperationalBase } from '@/shared/api/operational-bases/useOperationalBase'\nimport { useMap } from '@/shared/lib/composables/useMap'\nimport type { IDataFilters } from '@/shared/types/inputs/IDataFilters'\nimport VDataFilters from '@/shared/ui/inputs/VDataFilters.vue'\nimport type { CreateOperationalBaseDTO } from '@/shared/types/operational-bases/OperationalBaseDTOs'\nimport { DefaultMapCoordinates } from '@/shared/config/maps/Coordinates'\nimport { useOperationalBasesStore } from '@/shared/api/stores/operationalBase'\nimport { useUiStore } from '@/shared/lib/composables/ui'\nimport type { IOperationalBase } from '@/shared/types/operational-bases/IOperationalBase'\nimport { AppPermissions } from '@/shared/types/enums/permissions/permissions'\n\nconst { validateForm, actionIsInProgress, actionIsInError, actionIsInSuccess } = useUi()\nconst {\n  operationalBaseActions,\n  createOperationalBase,\n} = useOperationalBase()\n\nconst { storeFilterState } = storeToRefs(useUiStore())\nconst { storeAddOperationalBase } = useOperationalBasesStore()\n\nconst createOperationalBaseFormElement = ref<HTMLFormElement | null>(null)\n\nconst {\n  createMap,\n  addLayersToMap,\n  createOperationalBaseMarker,\n  resetMapView,\n  tidyUpMap,\n} = useMap()\n\nconst filterState = ref<IDataFilters>({\n  selectedDepartment: null,\n  selectedOperationalBase: null,\n  selectedRole: null,\n  selectedMonth: '',\n  selectedDate: '',\n})\n\nconst createOperationalBaseDTO = ref<CreateOperationalBaseDTO>({\n  departmentId: 0,\n  name: '',\n  longitude: DefaultMapCoordinates.LNG,\n  latitude: DefaultMapCoordinates.LAT,\n})\n\nconst handleFilterStateUpdate = async (newFilterState: IDataFilters) => {\n  filterState.value = newFilterState\n  if (newFilterState.selectedDepartment) {\n    createOperationalBaseDTO.value.departmentId = newFilterState.selectedDepartment.id\n  }\n}\n\nconst handleCreateOperationalBase = async () => {\n  const operationalBase = await validateForm<IOperationalBase>(createOperationalBaseFormElement.value, () => createOperationalBase(createOperationalBaseDTO.value))\n\n  if (\n    operationalBase\n    && operationalBase.department.id === storeFilterState.value.selectedDepartment?.id\n  ) {\n    storeAddOperationalBase(operationalBase)\n  }\n}\n\nlet map: L.Map | null = null\nconst handleUpdateMap = () => {\n  map = createMap(\n    Number.parseFloat(createOperationalBaseDTO.value.latitude),\n    Number.parseFloat(createOperationalBaseDTO.value.longitude),\n    3,\n  )\n  addLayersToMap(map)\n\n  // Place the initial marker at the center of the map\n  let operationalBaseLocationMarker = createOperationalBaseMarker(\n    Number.parseFloat(createOperationalBaseDTO.value.latitude),\n    Number.parseFloat(createOperationalBaseDTO.value.longitude),\n  )\n  operationalBaseLocationMarker.addTo(map)\n\n  map.on('click', (e) => {\n    createOperationalBaseDTO.value.latitude = e.latlng.lat.toString()\n    createOperationalBaseDTO.value.longitude = e.latlng.lng.toString()\n\n    // Remove the previous marker\n    if (operationalBaseLocationMarker) {\n      map!.removeLayer(operationalBaseLocationMarker)\n    }\n\n    // Add a new marker where the map was clicked\n    operationalBaseLocationMarker = createOperationalBaseMarker(\n      e.latlng.lat,\n      e.latlng.lng,\n    )\n    operationalBaseLocationMarker.addTo(map!)\n  })\n\n  // This is important- the map needs to be reset because of the way the\n  // side bar comes in to view. Otherwise the tiles are offset.\n  resetMapView(\n    map,\n    Number.parseFloat(createOperationalBaseDTO.value.latitude),\n    Number.parseFloat(createOperationalBaseDTO.value.longitude),\n    7,\n  )\n}\n\nonMounted(() => {\n  nextTick(() => {\n    setTimeout(() => {\n      handleUpdateMap()\n    }, 400)\n  })\n})\n\nonBeforeUnmount(() => {\n  tidyUpMap(map!)\n})\n</script>\n\n<template>\n  <RightDrawer>\n    <div class=\"isolate flex flex-col items-center justify-center border-l bg-white pb-6\">\n      <!-- important to increase z index to sit on top of map -->\n      <div class=\"sticky top-0 z-[9999999] flex w-full items-center justify-end bg-white p-6\">\n        <ProgressSpinner\n          v-if=\"actionIsInProgress(operationalBaseActions.createOperationalBase)\"\n          class=\"h-5 w-5 text-blue-500\"\n        />\n        <RouterLink\n          v-else\n          :to=\"{ name: $Routes.OperationalBases }\"\n        >\n          <IconClose class=\"h-5 w-5 fill-red-400\" />\n        </RouterLink>\n      </div>\n      <form\n        id=\"create_operational_base_form\"\n        ref=\"createOperationalBaseFormElement\"\n        class=\"w-full space-y-8 divide-y divide-gray-200 px-6 md:px-12\"\n      >\n        <div class=\"mb-6\">\n          <h3 class=\"text-base font-semibold leading-6 text-gray-900\">\n            Create Operational Base.\n          </h3>\n          <p class=\"mt-1 text-sm text-gray-500\">\n            Use the form below to create a new Operational Base.\n          </p>\n        </div>\n\n        <div class=\"grid grid-cols-1 gap-x-4 gap-y-6 pt-6\">\n          <VDataFilters\n            :department-permissions-required=\"[\n              AppPermissions.MANAGE_OPERATIONAL_BASES,\n            ]\"\n            :filter-state=\"filterState\"\n            @filter-state-updated=\"handleFilterStateUpdate\"\n          />\n\n          <div>\n            <label\n              for=\"operational_base_name\"\n              class=\"block text-sm font-medium text-gray-700\"\n            >\n              Operational Base Name\n            </label>\n            <div class=\"mt-1\">\n              <input\n                id=\"operational_base_name\"\n                v-model=\"createOperationalBaseDTO.name\"\n                type=\"text\"\n                class=\"block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm\"\n                required\n              >\n            </div>\n          </div>\n\n          <div class=\"flex flex-col\">\n            <label for=\"operational_base_name\" class=\"mb-1 block text-sm font-medium text-gray-700\">\n              Location\n            </label>\n            <div\n              id=\"map\"\n              class=\"h-[400px] w-full bg-gray-100\"\n            />\n            <p class=\"text-xs italic text-gray-500\">\n              {{ createOperationalBaseDTO.latitude }}, {{ createOperationalBaseDTO.longitude }}\n            </p>\n          </div>\n        </div>\n\n        <div class=\"relative pt-5\">\n          <div class=\"flex items-center justify-end\">\n            <Transition name=\"alert\">\n              <ActionSuccessAlert\n                v-if=\"actionIsInSuccess(operationalBaseActions.createOperationalBase)\"\n                :action=\"operationalBaseActions.createOperationalBase\"\n              />\n            </Transition>\n            <Transition name=\"alert\">\n              <ActionErrorAlert\n                v-if=\"actionIsInError(operationalBaseActions.createOperationalBase)\"\n                :action=\"operationalBaseActions.createOperationalBase\"\n              />\n            </Transition>\n            <div class=\"flex items-center\">\n              <button\n                class=\"ml-3 inline-flex h-9 items-center justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm focus:outline-none hover:bg-blue-700\"\n                @click.prevent=\"handleCreateOperationalBase\"\n              >\n                <span v-if=\"!actionIsInProgress(operationalBaseActions.createOperationalBase)\">\n                  Save Operational Base\n                </span>\n                <ProgressSpinner\n                  v-else\n                  class=\"h-3 w-3 text-white\"\n                />\n              </button>\n            </div>\n          </div>\n        </div>\n      </form>\n    </div>\n  </RightDrawer>\n</template>\n"],"names":["DefaultMapCoordinates","validateForm","actionIsInProgress","actionIsInError","actionIsInSuccess","useUi","operationalBaseActions","createOperationalBase","useOperationalBase","storeFilterState","storeToRefs","useUiStore","storeAddOperationalBase","useOperationalBasesStore","createOperationalBaseFormElement","ref","createMap","addLayersToMap","createOperationalBaseMarker","resetMapView","tidyUpMap","useMap","filterState","createOperationalBaseDTO","handleFilterStateUpdate","newFilterState","handleCreateOperationalBase","operationalBase","_a","map","handleUpdateMap","operationalBaseLocationMarker","e","onMounted","nextTick","onBeforeUnmount"],"mappings":"2iGAAY,IAAAA,GAAAA,IACVA,EAAA,IAAM,YACNA,EAAA,IAAM,aAFIA,IAAAA,GAAA,CAAA,CAAA,i+BCqBZ,KAAM,CAAE,aAAAC,EAAc,mBAAAC,EAAoB,gBAAAC,EAAiB,kBAAAC,CAAA,EAAsBC,IAC3E,CACJ,uBAAAC,EACA,sBAAAC,GACEC,GAAmB,EAEjB,CAAE,iBAAAC,CAAqB,EAAAC,EAAYC,EAAY,CAAA,EAC/C,CAAE,wBAAAC,GAA4BC,KAE9BC,EAAmCC,EAA4B,IAAI,EAEnE,CACJ,UAAAC,EACA,eAAAC,EACA,4BAAAC,EACA,aAAAC,EACA,UAAAC,GACEC,GAAO,EAELC,EAAcP,EAAkB,CACpC,mBAAoB,KACpB,wBAAyB,KACzB,aAAc,KACd,cAAe,GACf,aAAc,EAAA,CACf,EAEKQ,EAA2BR,EAA8B,CAC7D,aAAc,EACd,KAAM,GACN,UAAWf,EAAsB,IACjC,SAAUA,EAAsB,GAAA,CACjC,EAEKwB,EAA0B,MAAOC,GAAiC,CACtEH,EAAY,MAAQG,EAChBA,EAAe,qBACQF,EAAA,MAAM,aAAeE,EAAe,mBAAmB,GAClF,EAGIC,EAA8B,SAAY,OACxC,MAAAC,EAAkB,MAAM1B,EAA+Ba,EAAiC,MAAO,IAAMP,EAAsBgB,EAAyB,KAAK,CAAC,EAG9JI,GACGA,EAAgB,WAAW,OAAOC,EAAAnB,EAAiB,MAAM,qBAAvB,YAAAmB,EAA2C,KAEhFhB,EAAwBe,CAAe,CACzC,EAGF,IAAIE,EAAoB,KACxB,MAAMC,EAAkB,IAAM,CACtBD,EAAAb,EACJ,OAAO,WAAWO,EAAyB,MAAM,QAAQ,EACzD,OAAO,WAAWA,EAAyB,MAAM,SAAS,EAC1D,CAAA,EAEFN,EAAeY,CAAG,EAGlB,IAAIE,EAAgCb,EAClC,OAAO,WAAWK,EAAyB,MAAM,QAAQ,EACzD,OAAO,WAAWA,EAAyB,MAAM,SAAS,CAAA,EAE5DQ,EAA8B,MAAMF,CAAG,EAEnCA,EAAA,GAAG,QAAUG,GAAM,CACrBT,EAAyB,MAAM,SAAWS,EAAE,OAAO,IAAI,WACvDT,EAAyB,MAAM,UAAYS,EAAE,OAAO,IAAI,WAGpDD,GACFF,EAAK,YAAYE,CAA6B,EAIhBA,EAAAb,EAC9Bc,EAAE,OAAO,IACTA,EAAE,OAAO,GAAA,EAEXD,EAA8B,MAAMF,CAAI,CAAA,CACzC,EAIDV,EACEU,EACA,OAAO,WAAWN,EAAyB,MAAM,QAAQ,EACzD,OAAO,WAAWA,EAAyB,MAAM,SAAS,EAC1D,CAAA,CACF,EAGF,OAAAU,EAAU,IAAM,CACdC,EAAS,IAAM,CACb,WAAW,IAAM,CACCJ,KACf,GAAG,CAAA,CACP,CAAA,CACF,EAEDK,EAAgB,IAAM,CACpBf,EAAUS,CAAI,CAAA,CACf"}